{"ast":null,"code":"import axios from 'axios';\nimport AuthService from './auth.service';\nimport jwtDecode from 'jwt-decode';\nconst API_URL = \"http://localhost:8000/api/cliente/\";\nclass ClienteService {\n  constructor() {\n    this.refreshAuth();\n  }\n  refreshAuth() {\n    const user = AuthService.getCurrentUser();\n    if (user && user.accessToken) {\n      // Configuração global para todas as requisições axios\n      axios.defaults.headers.common['Authorization'] = 'Bearer ' + user.accessToken;\n      axios.defaults.headers.common['x-access-token'] = user.accessToken;\n      console.log(\"ClienteService - Token disponível:\", user.accessToken ? \"Sim\" : \"Não\");\n      console.log(\"ClienteService - Token configurado nos headers do Axios\");\n    }\n  }\n  isTokenExpired(token) {\n    try {\n      const decoded = jwtDecode(token);\n      const currentTime = Date.now() / 1000;\n      return decoded.exp < currentTime;\n    } catch (error) {\n      console.error(\"Erro ao decodificar token:\", error);\n      return true;\n    }\n  }\n  async getClienteProfile() {\n    try {\n      console.log(\"Buscando perfil do cliente em: \" + API_URL + \"perfil\");\n      const user = AuthService.getCurrentUser();\n\n      // Verificar se temos o token disponível\n      if (!user || !user.accessToken) {\n        console.error(\"Token de autenticação não disponível\");\n        return {\n          error: true,\n          message: \"Token não disponível\"\n        };\n      }\n\n      // Verificar se o token está expirado\n      if (this.isTokenExpired(user.accessToken)) {\n        console.error(\"Token expirado, tentando renovar...\");\n        // Aqui pode-se implementar lógica para renovar o token\n        // Por enquanto, retornaremos um erro\n        return {\n          error: true,\n          message: \"Token expirado\"\n        };\n      }\n      console.log(\"Enviando token:\", user.accessToken.substring(0, 20) + \"...\");\n      console.log(\"ID do usuário:\", user.id);\n\n      // Método direto: usando a instância axios com interceptadores personalizados\n      const axiosInstance = axios.create({\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer ' + user.accessToken,\n          'x-access-token': user.accessToken\n        }\n      });\n\n      // Interceptador para adicionar detalhes à requisição\n      axiosInstance.interceptors.request.use(config => {\n        console.log(\"Enviando requisição com cabeçalhos:\", config.headers);\n        return config;\n      }, error => {\n        console.error(\"Erro no interceptador de requisição:\", error);\n        return Promise.reject(error);\n      });\n      try {\n        const response = await axiosInstance.get(API_URL + \"perfil\");\n        console.log(\"Resposta recebida:\", response.data);\n        return response;\n      } catch (error) {\n        console.log(\"Tentando com parâmetro de query...\");\n\n        // Tentativa alternativa: usando o token como parâmetro de query\n        try {\n          return await axiosInstance.get(`${API_URL}perfil?token=${user.accessToken}`);\n        } catch (tokenQueryError) {\n          console.log(\"Tentativa com token na query falhou, tentando POST...\");\n\n          // Última tentativa: enviar como POST com o token no corpo\n          try {\n            return await axiosInstance.post(API_URL + \"perfil\", {\n              token: user.accessToken,\n              userId: user.id\n            });\n          } catch (postError) {\n            console.error(\"Todas as tentativas falharam\");\n            throw error; // Lançamos o erro original\n          }\n        }\n      }\n    } catch (error) {\n      this.logErrorDetails(error);\n      throw error;\n    }\n  }\n  logErrorDetails(error) {\n    console.error(\"Erro ao comunicar com a API:\", error.message);\n    if (error.response) {\n      console.log(\"Status:\", error.response.status);\n      console.log(\"Dados:\", error.response.data);\n      console.log(\"Headers:\", error.response.headers);\n      console.log(\"Cabeçalhos enviados:\", error.config.headers);\n    } else if (error.request) {\n      console.log(\"Request enviado, sem resposta:\", error.request);\n    }\n    console.log(\"Config completa:\", error.config);\n  }\n\n  // Atualizar perfil do cliente\n  async updateClienteProfile(clienteData) {\n    this.refreshAuth(); // Garante que o token está atualizado\n    console.log(\"Atualizando perfil, dados:\", clienteData);\n    return axios.put(`${API_URL}/perfil`, clienteData, {\n      headers: {\n        \"x-access-token\": AuthService.getCurrentUser().accessToken,\n        \"Authorization\": \"Bearer \" + AuthService.getCurrentUser().accessToken\n      }\n    });\n  }\n\n  // Obter histórico de consultas do cliente\n  async getConsultas() {\n    this.refreshAuth(); // Garante que o token está atualizado\n    return axios.get(`${API_URL}/consultas`, {\n      headers: {\n        \"x-access-token\": AuthService.getCurrentUser().accessToken,\n        \"Authorization\": \"Bearer \" + AuthService.getCurrentUser().accessToken\n      }\n    });\n  }\n}\nexport default new ClienteService();","map":{"version":3,"names":["axios","AuthService","jwtDecode","API_URL","ClienteService","constructor","refreshAuth","user","getCurrentUser","accessToken","defaults","headers","common","console","log","isTokenExpired","token","decoded","currentTime","Date","now","exp","error","getClienteProfile","message","substring","id","axiosInstance","create","interceptors","request","use","config","Promise","reject","response","get","data","tokenQueryError","post","userId","postError","logErrorDetails","status","updateClienteProfile","clienteData","put","getConsultas"],"sources":["C:/Users/s0ares/clinicadentaria_ai2/client/src/services/cliente.service.js"],"sourcesContent":["import axios from 'axios';\r\nimport AuthService from './auth.service';\r\nimport jwtDecode from 'jwt-decode';\r\n\r\nconst API_URL = \"http://localhost:8000/api/cliente/\";\r\n\r\nclass ClienteService {\r\n  constructor() {\r\n    this.refreshAuth();\r\n  }\r\n  \r\n  refreshAuth() {\r\n    const user = AuthService.getCurrentUser();\r\n    if (user && user.accessToken) {\r\n      // Configuração global para todas as requisições axios\r\n      axios.defaults.headers.common['Authorization'] = 'Bearer ' + user.accessToken;\r\n      axios.defaults.headers.common['x-access-token'] = user.accessToken;\r\n      \r\n      console.log(\"ClienteService - Token disponível:\", user.accessToken ? \"Sim\" : \"Não\");\r\n      console.log(\"ClienteService - Token configurado nos headers do Axios\");\r\n    }\r\n  }\r\n\r\n  isTokenExpired(token) {\r\n    try {\r\n      const decoded = jwtDecode(token);\r\n      const currentTime = Date.now() / 1000;\r\n      return decoded.exp < currentTime;\r\n    } catch (error) {\r\n      console.error(\"Erro ao decodificar token:\", error);\r\n      return true;\r\n    }\r\n  }\r\n\r\n  async getClienteProfile() {\r\n    try {\r\n      console.log(\"Buscando perfil do cliente em: \" + API_URL + \"perfil\");\r\n      const user = AuthService.getCurrentUser();\r\n      \r\n      // Verificar se temos o token disponível\r\n      if (!user || !user.accessToken) {\r\n        console.error(\"Token de autenticação não disponível\");\r\n        return { error: true, message: \"Token não disponível\" };\r\n      }\r\n\r\n      // Verificar se o token está expirado\r\n      if (this.isTokenExpired(user.accessToken)) {\r\n        console.error(\"Token expirado, tentando renovar...\");\r\n        // Aqui pode-se implementar lógica para renovar o token\r\n        // Por enquanto, retornaremos um erro\r\n        return { error: true, message: \"Token expirado\" };\r\n      }\r\n\r\n      console.log(\"Enviando token:\", user.accessToken.substring(0, 20) + \"...\");\r\n      console.log(\"ID do usuário:\", user.id);\r\n      \r\n      // Método direto: usando a instância axios com interceptadores personalizados\r\n      const axiosInstance = axios.create({\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': 'Bearer ' + user.accessToken,\r\n          'x-access-token': user.accessToken\r\n        }\r\n      });\r\n      \r\n      // Interceptador para adicionar detalhes à requisição\r\n      axiosInstance.interceptors.request.use(\r\n        config => {\r\n          console.log(\"Enviando requisição com cabeçalhos:\", config.headers);\r\n          return config;\r\n        },\r\n        error => {\r\n          console.error(\"Erro no interceptador de requisição:\", error);\r\n          return Promise.reject(error);\r\n        }\r\n      );\r\n\r\n      try {\r\n        const response = await axiosInstance.get(API_URL + \"perfil\");\r\n        console.log(\"Resposta recebida:\", response.data);\r\n        return response;\r\n      } catch (error) {\r\n        console.log(\"Tentando com parâmetro de query...\");\r\n        \r\n        // Tentativa alternativa: usando o token como parâmetro de query\r\n        try {\r\n          return await axiosInstance.get(`${API_URL}perfil?token=${user.accessToken}`);\r\n        } catch (tokenQueryError) {\r\n          console.log(\"Tentativa com token na query falhou, tentando POST...\");\r\n          \r\n          // Última tentativa: enviar como POST com o token no corpo\r\n          try {\r\n            return await axiosInstance.post(API_URL + \"perfil\", { \r\n              token: user.accessToken,\r\n              userId: user.id\r\n            });\r\n          } catch (postError) {\r\n            console.error(\"Todas as tentativas falharam\");\r\n            throw error; // Lançamos o erro original\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      this.logErrorDetails(error);\r\n      throw error;\r\n    }\r\n  }\r\n  \r\n  logErrorDetails(error) {\r\n    console.error(\"Erro ao comunicar com a API:\", error.message);\r\n    if (error.response) {\r\n      console.log(\"Status:\", error.response.status);\r\n      console.log(\"Dados:\", error.response.data);\r\n      console.log(\"Headers:\", error.response.headers);\r\n      console.log(\"Cabeçalhos enviados:\", error.config.headers);\r\n    } else if (error.request) {\r\n      console.log(\"Request enviado, sem resposta:\", error.request);\r\n    }\r\n    console.log(\"Config completa:\", error.config);\r\n  }\r\n\r\n  // Atualizar perfil do cliente\r\n  async updateClienteProfile(clienteData) {\r\n    this.refreshAuth(); // Garante que o token está atualizado\r\n    console.log(\"Atualizando perfil, dados:\", clienteData);\r\n    return axios.put(`${API_URL}/perfil`, clienteData, {\r\n      headers: {\r\n        \"x-access-token\": AuthService.getCurrentUser().accessToken,\r\n        \"Authorization\": \"Bearer \" + AuthService.getCurrentUser().accessToken\r\n      }\r\n    });\r\n  }\r\n\r\n  // Obter histórico de consultas do cliente\r\n  async getConsultas() {\r\n    this.refreshAuth(); // Garante que o token está atualizado\r\n    return axios.get(`${API_URL}/consultas`, {\r\n      headers: {\r\n        \"x-access-token\": AuthService.getCurrentUser().accessToken,\r\n        \"Authorization\": \"Bearer \" + AuthService.getCurrentUser().accessToken\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nexport default new ClienteService();"],"mappings":"AAAA,OAAOA,KAAK,MAAM,OAAO;AACzB,OAAOC,WAAW,MAAM,gBAAgB;AACxC,OAAOC,SAAS,MAAM,YAAY;AAElC,MAAMC,OAAO,GAAG,oCAAoC;AAEpD,MAAMC,cAAc,CAAC;EACnBC,WAAWA,CAAA,EAAG;IACZ,IAAI,CAACC,WAAW,CAAC,CAAC;EACpB;EAEAA,WAAWA,CAAA,EAAG;IACZ,MAAMC,IAAI,GAAGN,WAAW,CAACO,cAAc,CAAC,CAAC;IACzC,IAAID,IAAI,IAAIA,IAAI,CAACE,WAAW,EAAE;MAC5B;MACAT,KAAK,CAACU,QAAQ,CAACC,OAAO,CAACC,MAAM,CAAC,eAAe,CAAC,GAAG,SAAS,GAAGL,IAAI,CAACE,WAAW;MAC7ET,KAAK,CAACU,QAAQ,CAACC,OAAO,CAACC,MAAM,CAAC,gBAAgB,CAAC,GAAGL,IAAI,CAACE,WAAW;MAElEI,OAAO,CAACC,GAAG,CAAC,oCAAoC,EAAEP,IAAI,CAACE,WAAW,GAAG,KAAK,GAAG,KAAK,CAAC;MACnFI,OAAO,CAACC,GAAG,CAAC,yDAAyD,CAAC;IACxE;EACF;EAEAC,cAAcA,CAACC,KAAK,EAAE;IACpB,IAAI;MACF,MAAMC,OAAO,GAAGf,SAAS,CAACc,KAAK,CAAC;MAChC,MAAME,WAAW,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAG,IAAI;MACrC,OAAOH,OAAO,CAACI,GAAG,GAAGH,WAAW;IAClC,CAAC,CAAC,OAAOI,KAAK,EAAE;MACdT,OAAO,CAACS,KAAK,CAAC,4BAA4B,EAAEA,KAAK,CAAC;MAClD,OAAO,IAAI;IACb;EACF;EAEA,MAAMC,iBAAiBA,CAAA,EAAG;IACxB,IAAI;MACFV,OAAO,CAACC,GAAG,CAAC,iCAAiC,GAAGX,OAAO,GAAG,QAAQ,CAAC;MACnE,MAAMI,IAAI,GAAGN,WAAW,CAACO,cAAc,CAAC,CAAC;;MAEzC;MACA,IAAI,CAACD,IAAI,IAAI,CAACA,IAAI,CAACE,WAAW,EAAE;QAC9BI,OAAO,CAACS,KAAK,CAAC,sCAAsC,CAAC;QACrD,OAAO;UAAEA,KAAK,EAAE,IAAI;UAAEE,OAAO,EAAE;QAAuB,CAAC;MACzD;;MAEA;MACA,IAAI,IAAI,CAACT,cAAc,CAACR,IAAI,CAACE,WAAW,CAAC,EAAE;QACzCI,OAAO,CAACS,KAAK,CAAC,qCAAqC,CAAC;QACpD;QACA;QACA,OAAO;UAAEA,KAAK,EAAE,IAAI;UAAEE,OAAO,EAAE;QAAiB,CAAC;MACnD;MAEAX,OAAO,CAACC,GAAG,CAAC,iBAAiB,EAAEP,IAAI,CAACE,WAAW,CAACgB,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,GAAG,KAAK,CAAC;MACzEZ,OAAO,CAACC,GAAG,CAAC,gBAAgB,EAAEP,IAAI,CAACmB,EAAE,CAAC;;MAEtC;MACA,MAAMC,aAAa,GAAG3B,KAAK,CAAC4B,MAAM,CAAC;QACjCjB,OAAO,EAAE;UACP,cAAc,EAAE,kBAAkB;UAClC,eAAe,EAAE,SAAS,GAAGJ,IAAI,CAACE,WAAW;UAC7C,gBAAgB,EAAEF,IAAI,CAACE;QACzB;MACF,CAAC,CAAC;;MAEF;MACAkB,aAAa,CAACE,YAAY,CAACC,OAAO,CAACC,GAAG,CACpCC,MAAM,IAAI;QACRnB,OAAO,CAACC,GAAG,CAAC,qCAAqC,EAAEkB,MAAM,CAACrB,OAAO,CAAC;QAClE,OAAOqB,MAAM;MACf,CAAC,EACDV,KAAK,IAAI;QACPT,OAAO,CAACS,KAAK,CAAC,sCAAsC,EAAEA,KAAK,CAAC;QAC5D,OAAOW,OAAO,CAACC,MAAM,CAACZ,KAAK,CAAC;MAC9B,CACF,CAAC;MAED,IAAI;QACF,MAAMa,QAAQ,GAAG,MAAMR,aAAa,CAACS,GAAG,CAACjC,OAAO,GAAG,QAAQ,CAAC;QAC5DU,OAAO,CAACC,GAAG,CAAC,oBAAoB,EAAEqB,QAAQ,CAACE,IAAI,CAAC;QAChD,OAAOF,QAAQ;MACjB,CAAC,CAAC,OAAOb,KAAK,EAAE;QACdT,OAAO,CAACC,GAAG,CAAC,oCAAoC,CAAC;;QAEjD;QACA,IAAI;UACF,OAAO,MAAMa,aAAa,CAACS,GAAG,CAAC,GAAGjC,OAAO,gBAAgBI,IAAI,CAACE,WAAW,EAAE,CAAC;QAC9E,CAAC,CAAC,OAAO6B,eAAe,EAAE;UACxBzB,OAAO,CAACC,GAAG,CAAC,uDAAuD,CAAC;;UAEpE;UACA,IAAI;YACF,OAAO,MAAMa,aAAa,CAACY,IAAI,CAACpC,OAAO,GAAG,QAAQ,EAAE;cAClDa,KAAK,EAAET,IAAI,CAACE,WAAW;cACvB+B,MAAM,EAAEjC,IAAI,CAACmB;YACf,CAAC,CAAC;UACJ,CAAC,CAAC,OAAOe,SAAS,EAAE;YAClB5B,OAAO,CAACS,KAAK,CAAC,8BAA8B,CAAC;YAC7C,MAAMA,KAAK,CAAC,CAAC;UACf;QACF;MACF;IACF,CAAC,CAAC,OAAOA,KAAK,EAAE;MACd,IAAI,CAACoB,eAAe,CAACpB,KAAK,CAAC;MAC3B,MAAMA,KAAK;IACb;EACF;EAEAoB,eAAeA,CAACpB,KAAK,EAAE;IACrBT,OAAO,CAACS,KAAK,CAAC,8BAA8B,EAAEA,KAAK,CAACE,OAAO,CAAC;IAC5D,IAAIF,KAAK,CAACa,QAAQ,EAAE;MAClBtB,OAAO,CAACC,GAAG,CAAC,SAAS,EAAEQ,KAAK,CAACa,QAAQ,CAACQ,MAAM,CAAC;MAC7C9B,OAAO,CAACC,GAAG,CAAC,QAAQ,EAAEQ,KAAK,CAACa,QAAQ,CAACE,IAAI,CAAC;MAC1CxB,OAAO,CAACC,GAAG,CAAC,UAAU,EAAEQ,KAAK,CAACa,QAAQ,CAACxB,OAAO,CAAC;MAC/CE,OAAO,CAACC,GAAG,CAAC,sBAAsB,EAAEQ,KAAK,CAACU,MAAM,CAACrB,OAAO,CAAC;IAC3D,CAAC,MAAM,IAAIW,KAAK,CAACQ,OAAO,EAAE;MACxBjB,OAAO,CAACC,GAAG,CAAC,gCAAgC,EAAEQ,KAAK,CAACQ,OAAO,CAAC;IAC9D;IACAjB,OAAO,CAACC,GAAG,CAAC,kBAAkB,EAAEQ,KAAK,CAACU,MAAM,CAAC;EAC/C;;EAEA;EACA,MAAMY,oBAAoBA,CAACC,WAAW,EAAE;IACtC,IAAI,CAACvC,WAAW,CAAC,CAAC,CAAC,CAAC;IACpBO,OAAO,CAACC,GAAG,CAAC,4BAA4B,EAAE+B,WAAW,CAAC;IACtD,OAAO7C,KAAK,CAAC8C,GAAG,CAAC,GAAG3C,OAAO,SAAS,EAAE0C,WAAW,EAAE;MACjDlC,OAAO,EAAE;QACP,gBAAgB,EAAEV,WAAW,CAACO,cAAc,CAAC,CAAC,CAACC,WAAW;QAC1D,eAAe,EAAE,SAAS,GAAGR,WAAW,CAACO,cAAc,CAAC,CAAC,CAACC;MAC5D;IACF,CAAC,CAAC;EACJ;;EAEA;EACA,MAAMsC,YAAYA,CAAA,EAAG;IACnB,IAAI,CAACzC,WAAW,CAAC,CAAC,CAAC,CAAC;IACpB,OAAON,KAAK,CAACoC,GAAG,CAAC,GAAGjC,OAAO,YAAY,EAAE;MACvCQ,OAAO,EAAE;QACP,gBAAgB,EAAEV,WAAW,CAACO,cAAc,CAAC,CAAC,CAACC,WAAW;QAC1D,eAAe,EAAE,SAAS,GAAGR,WAAW,CAACO,cAAc,CAAC,CAAC,CAACC;MAC5D;IACF,CAAC,CAAC;EACJ;AACF;AAEA,eAAe,IAAIL,cAAc,CAAC,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}